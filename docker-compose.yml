version: '3.8'

services:
  # FastAPI Application
  fastapi:
    build: .
    container_name: smart-farming-api
    ports:
      - "8000:8000"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - INFLUXDB_URL=http://influxdb:8086
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=smart_farming
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    env_file:
      - .env
    depends_on:
      - redis
      - influxdb
      - postgres
    volumes:
      - ./app:/app/app
    restart: unless-stopped
    networks:
      - smart-farming-network

  # Redis - Event-driven communication
  redis:
    image: redis:7-alpine
    container_name: smart-farming-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - smart-farming-network

  # InfluxDB - Time-series database for sensor data
  influxdb:
    image: influxdb:2.7-alpine
    container_name: smart-farming-influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpassword
      - DOCKER_INFLUXDB_INIT_ORG=smart-farming
      - DOCKER_INFLUXDB_INIT_BUCKET=sensor-data
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=l4iGfnZMg7BDR_k3PwCl-HVPxVDFIzxqpjM6uNZ_NJ5jkmhLUZQkodXeuNzL4LFRvC73zg0hSYPH5ivYQKZfOQ==
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2
    restart: unless-stopped
    networks:
      - smart-farming-network

  # PostgreSQL - Relational database for farm configuration
  postgres:
    image: postgres:16-alpine
    container_name: smart-farming-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=smart_farming
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - smart-farming-network

  # pgAdmin - PostgreSQL web interface (optional)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: smart-farming-pgadmin
    ports:
      - "5050:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@smartfarming.com
      - PGADMIN_DEFAULT_PASSWORD=admin
    depends_on:
      - postgres
    restart: unless-stopped
    networks:
      - smart-farming-network

volumes:
  redis-data:
    driver: local
  influxdb-data:
    driver: local
  influxdb-config:
    driver: local
  postgres-data:
    driver: local

networks:
  smart-farming-network:
    driver: bridge
